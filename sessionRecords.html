<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPEAK - View Sessions</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <style>
        /* ... (keep all the existing CSS styles) ... */
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }
        
        .debug-info {
            background: #d1ecf1;
            color: #0c5460;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>SPEAK Session Records</h1>
            <p>Review and analyze your past speech practice sessions</p>
        </div>

        <div class="nav-buttons">
            <a href="/" class="btn btn-primary">Back to Live Analysis</a>
            <button class="btn btn-success" onclick="loadSessions()">Refresh Sessions</button>
            <button class="btn btn-info" onclick="createTestSession()">Create Test Session</button>
            <button class="btn btn-warning" onclick="debugSessions()">Debug</button>
        </div>

        <div class="content">
            <div class="sessions-header">
                <h2>Your Practice Sessions</h2>
                <div class="controls">
                    <span id="sessionCount">0 sessions</span>
                </div>
            </div>

            <div id="debugInfo" class="debug-info" style="display: none;"></div>

            <div id="sessionsContainer">
                <div class="loading">
                    <p>Loading your sessions...</p>
                </div>
            </div>

            <div id="sessionDetails" class="session-details">
                <!-- Session details will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        let currentSessions = [];
        let socket;
        let selectedSession = null;

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing sessions page...');

            // Check if there's a selected session in localStorage
            const storedSession = localStorage.getItem('selected_session');
            if (storedSession) {
                try {
                    selectedSession = JSON.parse(storedSession);
                    console.log('Found selected session:', selectedSession);
                    displaySelectedSessionDetails(selectedSession);
                    return; // Don't load session list if we have a selected session
                } catch (e) {
                    console.error('Error parsing stored session:', e);
                    localStorage.removeItem('selected_session'); // Clean up invalid data
                }
            }

            // If no selected session, show session list
            socket = io();

            socket.on('connected', function(data) {
                console.log('Connected to server');
                loadSessions();
            });

            socket.on('sessions_refreshed', function(data) {
                console.log('Sessions refreshed via WebSocket');
                displaySessions(data.sessions);
            });

            socket.on('sessions_refresh_error', function(data) {
                console.error('WebSocket refresh error:', data.error);
                showError('Error refreshing sessions: ' + data.error);
            });

            // Load sessions immediately
            loadSessions();
        });

        function displaySelectedSessionDetails(session) {
            console.log('Displaying selected session details:', session);

            // Update page title and header
            document.querySelector('h1').textContent = 'SPEAK Session Details';
            document.querySelector('p').textContent = `Viewing session: ${session.id}`;

            // Hide session list navigation
            document.querySelector('.nav-buttons').style.display = 'none';

            // Update sessions header
            document.querySelector('.sessions-header h2').textContent = `Session: ${session.id}`;
            document.getElementById('sessionCount').textContent = `Recorded: ${session.timestamp}`;

            // Clear sessions container and show session details
            const container = document.getElementById('sessionsContainer');
            container.innerHTML = '';

            // Display the session details directly
            const analysis = session.analysis || {};
            const coreMetrics = analysis.core_metrics || {};
            const recommendations = analysis.recommendations || [];
            const aiFeedback = session.ai_feedback;

            let html = `
                <div class="session-detail-view">
                    <div class="session-overview">
                        <h3>Session Analysis: ${escapeHtml(session.id)}</h3>
                        <div class="session-meta">
                            <div class="meta-item">
                                <strong>Recorded:</strong> ${session.timestamp}
                            </div>
                            <div class="meta-item">
                                <strong>Data Points:</strong> ${session.total_points}
                            </div>
                            <div class="meta-item">
                                <strong>Eye Contact Score:</strong> ${coreMetrics.eye_contact_score || 0}%
                            </div>
                        </div>
                    </div>

                    <div class="analysis-grid">
                        <div class="analysis-section">
                            <h4>Core Metrics</h4>
                            <div class="metrics-grid">
                                <div class="metric-item">
                                    <div class="metric-value">${coreMetrics.eye_contact_score || 0}%</div>
                                    <div class="metric-label">Eye Contact Score</div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-value">${coreMetrics.focus_consistency || 0}%</div>
                                    <div class="metric-label">Focus Consistency</div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-value">${coreMetrics.blink_count || 0}</div>
                                    <div class="metric-label">Blink Count</div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-value">${coreMetrics.blink_rate || 0}/s</div>
                                    <div class="metric-label">Blink Rate</div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-value">${session.total_points || 0}</div>
                                    <div class="metric-label">Data Points</div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-value">${analysis.session_duration || 0}s</div>
                                    <div class="metric-label">Session Duration</div>
                                </div>
                            </div>
                        </div>

                        ${recommendations.length > 0 ? `
                            <div class="analysis-section">
                                <h4>Recommendations</h4>
                                <div class="recommendations-list">
                                    ${recommendations.map(rec => `
                                        <div class="recommendation-item">${escapeHtml(rec)}</div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                        ${aiFeedback ? `
                            <div class="analysis-section">
                                <h4>AI-Powered Feedback</h4>
                                <div class="ai-feedback-summary">
                                    <div class="ai-rating">
                                        <strong>Performance Rating:</strong> ${aiFeedback.performance_rating || 'Analyzed'}
                                    </div>
                                    <div class="ai-assessment">
                                        <strong>Overall Assessment:</strong> ${aiFeedback.overall_assessment || 'AI analysis completed'}
                                    </div>
                                    ${aiFeedback.key_strengths && aiFeedback.key_strengths.length > 0 ? `
                                        <div class="ai-strengths">
                                            <strong>Key Strengths:</strong>
                                            <ul>
                                                ${aiFeedback.key_strengths.map(strength => `<li>${escapeHtml(strength)}</li>`).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                    ${aiFeedback.areas_for_improvement && aiFeedback.areas_for_improvement.length > 0 ? `
                                        <div class="ai-improvements">
                                            <strong>Areas for Improvement:</strong>
                                            <ul>
                                                ${aiFeedback.areas_for_improvement.map(area => `<li>${escapeHtml(area)}</li>`).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        ` : ''}
                    </div>

                    <!-- Visualizations -->
                    <div class="visualizations" id="sessionVisualizations" style="grid-template-columns: repeat(2, 1fr);">
                        <div class="chart-container">
                            <h3><i class="fas fa-chart-pie"></i> Eye Contact Distribution</h3>
                            <canvas id="sessionEyeContactChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3><i class="fas fa-chart-bar"></i> Performance Metrics</h3>
                            <canvas id="sessionMetricsChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3><i class="fas fa-wave-square"></i> Focus Pattern</h3>
                            <canvas id="sessionFocusChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3><i class="fas fa-eye"></i> Blink Analysis</h3>
                            <canvas id="sessionBlinkChart"></canvas>
                        </div>
                    </div>

                    <div class="session-actions">
                        <button class="btn btn-primary" onclick="backToSessions()">
                            <i class="fas fa-arrow-left"></i> Back to Sessions
                        </button>
                        <button class="btn btn-info" onclick="exportSession('${escapeHtml(session.id)}')">
                            <i class="fas fa-download"></i> Export Session
                        </button>
                        <button class="btn btn-danger" onclick="deleteSession('${escapeHtml(session.id)}')">
                            <i class="fas fa-trash"></i> Delete Session
                        </button>
                    </div>
                </div>
            `;

            container.innerHTML = html;

            // Create charts after HTML is inserted
            setTimeout(() => {
                createSessionCharts(session);
            }, 100);
        }

        function backToSessions() {
            // Clear localStorage and redirect to sessions list
            localStorage.removeItem('selected_session');
            window.location.href = '/session';
        }

        function loadSessions() {
            console.log('Loading sessions from API...');
            showLoading();

            fetch('/sessions')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Sessions API response:', data);

                    if (data.success === false) {
                        throw new Error(data.error || 'Unknown API error');
                    }

                    if (data.sessions) {
                        displaySessions(data.sessions);
                    } else {
                        throw new Error('No sessions data in response');
                    }
                })
                .catch(error => {
                    console.error('Error loading sessions:', error);
                    showError('Failed to load sessions: ' + error.message);
                });
        }

        function displaySessions(sessions) {
            console.log('Displaying sessions:', sessions);
            currentSessions = sessions;
            const container = document.getElementById('sessionsContainer');
            const sessionCount = document.getElementById('sessionCount');
            
            sessionCount.textContent = `${sessions.length} session${sessions.length !== 1 ? 's' : ''}`;
            
            if (sessions.length === 0) {
                container.innerHTML = `
                    <div class="no-sessions">
                        <h3>No Sessions Recorded Yet</h3>
                        <p>Start your first speech practice session to see your analysis here!</p>
                        <div style="margin-top: 20px;">
                            <a href="/" class="btn btn-primary">Start Your First Session</a>
                            <button class="btn btn-info" onclick="createTestSession()">Create Test Session</button>
                        </div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="sessions-grid">
                    ${sessions.map(session => `
                        <div class="session-card ${session.error ? 'error' : ''}">
                            <div class="session-header">
                                <div>
                                    <div class="session-id">${escapeHtml(session.id)}</div>
                                    <div class="session-timestamp">${formatTimestamp(session.timestamp)}</div>
                                </div>
                                <div class="status-indicator ${getStatusClass(session.eye_contact)}">
                                    ${getStatusText(session.eye_contact)}
                                </div>
                            </div>
                            
                            ${session.error ? `
                                <div style="color: #dc3545; margin-bottom: 15px;">
                                    <strong>Error:</strong> ${escapeHtml(session.error)}
                                </div>
                            ` : `
                                <div class="session-metrics">
                                    <div class="metric">
                                        <div class="metric-value">${session.eye_contact}%</div>
                                        <div class="metric-label">Eye Contact</div>
                                    </div>
                                    <div class="metric">
                                        <div class="metric-value">${session.total_points}</div>
                                        <div class="metric-label">Data Points</div>
                                    </div>
                                    <div class="metric">
                                        <div class="metric-value">${session.blink_count}</div>
                                        <div class="metric-label">Blinks</div>
                                    </div>
                                    <div class="metric">
                                        <div class="metric-value">${session.session_duration}s</div>
                                        <div class="metric-label">Duration</div>
                                    </div>
                                </div>
                            `}
                            
                            <div class="session-actions">
                                <button class="btn btn-info" onclick="viewSessionDetails('${escapeHtml(session.id)}')">
                                    View Details
                                </button>
                                <button class="btn btn-danger" onclick="deleteSession('${escapeHtml(session.id)}')">
                                    Delete
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function viewSessionDetails(sessionId) {
            console.log('Viewing session details:', sessionId);
            showLoadingDetails();
            
            fetch(`/session/${sessionId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(sessionData => {
                    console.log('Session details loaded:', sessionData);
                    displaySessionDetails(sessionId, sessionData);
                })
                .catch(error => {
                    console.error('Error loading session details:', error);
                    showError('Error loading session details: ' + error.message);
                });
        }

        function displaySessionDetails(sessionId, sessionData) {
            const detailsContainer = document.getElementById('sessionDetails');
            const analysis = sessionData.analysis || {};
            const coreMetrics = analysis.core_metrics || {};
            const recommendations = analysis.recommendations || [];
            
            detailsContainer.innerHTML = `
                <h3>Detailed Analysis: ${escapeHtml(sessionId)}</h3>
                <div class="details-grid">
                    <div class="detail-item">
                        <div class="detail-value">${coreMetrics.eye_contact_score || 0}%</div>
                        <div class="detail-label">Eye Contact Score</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-value">${coreMetrics.focus_consistency || 0}%</div>
                        <div class="detail-label">Focus Consistency</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-value">${coreMetrics.blink_count || 0}</div>
                        <div class="detail-label">Blink Count</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-value">${coreMetrics.blink_rate || 0}/s</div>
                        <div class="detail-label">Blink Rate</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-value">${sessionData.total_points || 0}</div>
                        <div class="detail-label">Data Points</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-value">${analysis.session_duration || 0}s</div>
                        <div class="detail-label">Session Duration</div>
                    </div>
                </div>
                
                ${recommendations.length > 0 ? `
                    <div class="recommendations">
                        <h4>Professional Recommendations</h4>
                        ${recommendations.map(rec => `
                            <div class="recommendation-card">${escapeHtml(rec)}</div>
                        `).join('')}
                    </div>
                ` : `
                    <div class="recommendations">
                        <h4>Professional Recommendations</h4>
                        <div class="recommendation-card">No recommendations available for this session</div>
                    </div>
                `}
                
                <div style="margin-top: 20px; text-align: center;">
                    <button class="btn btn-warning" onclick="closeSessionDetails()">Close Details</button>
                    <button class="btn btn-info" onclick="exportSession('${escapeHtml(sessionId)}')">Export This Session</button>
                </div>
            `;
            
            detailsContainer.classList.add('active');
            
            // Scroll to details
            detailsContainer.scrollIntoView({ behavior: 'smooth' });
        }

        function closeSessionDetails() {
            const detailsContainer = document.getElementById('sessionDetails');
            detailsContainer.classList.remove('active');
        }

        function deleteSession(sessionId) {
            if (!confirm('Are you sure you want to delete this session? This action cannot be undone.')) {
                return;
            }
            
            fetch(`/api/session/${sessionId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showTemporaryMessage('Session deleted successfully!', 'success');
                    loadSessions(); // Refresh the list
                    closeSessionDetails();
                } else {
                    showError('Error deleting session: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                showError('Error deleting session: ' + error.message);
            });
        }

        function createTestSession() {
            // Create a test session for debugging
            const testSession = {
                timestamp: new Date().toISOString(),
                total_points: 150,
                analysis: {
                    core_metrics: {
                        eye_contact_score: 75,
                        blink_count: 12,
                        focus_consistency: 80,
                        blink_rate: 0.4
                    },
                    recommendations: [
                        "Great eye contact! Maintain this level for professional settings",
                        "Try varying your gaze patterns to appear more natural",
                        "Practice with different audience sizes to build versatility"
                    ],
                    session_duration: 45.5
                }
            };
            
            // Save test session
            const sessionId = 'test_session_' + Date.now();
            fetch('/api/session/' + sessionId, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(testSession)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showTemporaryMessage('Test session created successfully!', 'success');
                    loadSessions();
                } else {
                    showError('Error creating test session: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                showError('Error creating test session: ' + error.message);
            });
        }

        function debugSessions() {
            const debugContainer = document.getElementById('debugInfo');
            debugContainer.innerHTML = `
                <strong>Debug Information:</strong><br>
                - Current sessions: ${currentSessions.length}<br>
                - API endpoint: /api/sessions<br>
                - Socket connected: ${socket && socket.connected}<br>
                - Last update: ${new Date().toLocaleTimeString()}
            `;
            debugContainer.style.display = 'block';
            
            // Also log to console
            console.log('Debug info:', {
                sessionsCount: currentSessions.length,
                sessions: currentSessions,
                socketConnected: socket && socket.connected
            });
        }

        // Utility functions
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function formatTimestamp(timestamp) {
            try {
                if (timestamp === 'Error loading' || timestamp === 'Unknown') {
                    return timestamp;
                }
                const date = new Date(timestamp);
                return isNaN(date.getTime()) ? timestamp : date.toLocaleString();
            } catch (e) {
                return timestamp;
            }
        }

        function getStatusClass(eyeContactScore) {
            if (eyeContactScore >= 70) return 'status-good';
            if (eyeContactScore >= 40) return 'status-fair';
            return 'status-poor';
        }

        function getStatusText(eyeContactScore) {
            if (eyeContactScore >= 70) return 'Excellent';
            if (eyeContactScore >= 40) return 'Fair';
            return 'Needs Practice';
        }

        function showLoading() {
            document.getElementById('sessionsContainer').innerHTML = `
                <div class="loading">
                    <p>Loading your sessions...</p>
                </div>
            `;
        }

        function showLoadingDetails() {
            const detailsContainer = document.getElementById('sessionDetails');
            detailsContainer.innerHTML = `
                <div class="loading">
                    <p>Loading session details...</p>
                </div>
            `;
            detailsContainer.classList.add('active');
        }

        function showError(message) {
            document.getElementById('sessionsContainer').innerHTML = `
                <div class="error-message">
                    <h3>Error Loading Sessions</h3>
                    <p>${escapeHtml(message)}</p>
                    <button class="btn btn-primary" onclick="loadSessions()" style="margin-top: 10px;">
                        Try Again
                    </button>
                    <button class="btn btn-info" onclick="debugSessions()" style="margin-top: 10px;">
                        Debug Info
                    </button>
                </div>
            `;
        }

        function showTemporaryMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `temp-message temp-${type}`;
            messageDiv.textContent = message;
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                background: ${type === 'success' ? '#d4edda' : '#f8d7da'};
                color: ${type === 'success' ? '#155724' : '#721c24'};
                border: 1px solid ${type === 'success' ? '#c3e6cb' : '#f5c6cb'};
                border-radius: 5px;
                z-index: 10000;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            `;
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }

        // The server provides a POST API at /api/session/<session_id> to save test sessions.
        // Client-side code (createTestSession) calls that endpoint using fetch() and expects
        // a JSON response like { success: true } on success.

        // Refresh sessions every 30 seconds to catch new sessions
        setInterval(loadSessions, 30000);

        function createSessionCharts(session) {
            const analysis = session.analysis || {};
            const coreMetrics = analysis.core_metrics || {};
            const eyeContactScore = coreMetrics.eye_contact_score || 0;
            const focusConsistency = coreMetrics.focus_consistency || 0;
            const blinkCount = coreMetrics.blink_count || 0;
            const blinkRate = coreMetrics.blink_rate || 0;

            // Eye Contact Distribution Chart (Pie)
            const eyeContactCtx = document.getElementById('sessionEyeContactChart');
            if (eyeContactCtx) {
                new Chart(eyeContactCtx, {
                    type: 'pie',
                    data: {
                        labels: ['Eye Contact', 'No Eye Contact'],
                        datasets: [{
                            data: [eyeContactScore, 100 - eyeContactScore],
                            backgroundColor: ['#28a745', '#dc3545'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                            }
                        }
                    }
                });
            }

            // Performance Metrics Chart (Bar)
            const metricsCtx = document.getElementById('sessionMetricsChart');
            if (metricsCtx) {
                new Chart(metricsCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Eye Contact', 'Focus Consistency'],
                        datasets: [{
                            label: 'Score (%)',
                            data: [eyeContactScore, focusConsistency],
                            backgroundColor: ['#007bff', '#17a2b8'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100
                            }
                        }
                    }
                });
            }

            // Focus Pattern Chart (Line - simulated)
            const focusCtx = document.getElementById('sessionFocusChart');
            if (focusCtx) {
                // Generate simulated focus data based on consistency score
                const dataPoints = 20;
                const focusData = [];
                for (let i = 0; i < dataPoints; i++) {
                    const baseValue = focusConsistency;
                    const variation = (Math.random() - 0.5) * 20; // Â±10 variation
                    focusData.push(Math.max(0, Math.min(100, baseValue + variation)));
                }

                new Chart(focusCtx, {
                    type: 'line',
                    data: {
                        labels: Array.from({length: dataPoints}, (_, i) => `T${i+1}`),
                        datasets: [{
                            label: 'Focus Level',
                            data: focusData,
                            borderColor: '#ffc107',
                            backgroundColor: 'rgba(255, 193, 7, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100
                            }
                        }
                    }
                });
            }

            // Blink Analysis Chart (Bar)
            const blinkCtx = document.getElementById('sessionBlinkChart');
            if (blinkCtx) {
                new Chart(blinkCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Blink Count', 'Blink Rate (/s)'],
                        datasets: [{
                            label: 'Value',
                            data: [blinkCount, blinkRate],
                            backgroundColor: ['#6f42c1', '#e83e8c'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
        }
    </script>
</body>
</html>